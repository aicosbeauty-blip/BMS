<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ ‡é¢˜å°†ç”±JSåŠ¨æ€è®¾ç½® -->
    <title>å†å¹´ç»¼åˆåˆ†ææŠ¥å‘Š</title>
    <!-- å¼•å…¥ Chart.js ç”¨äºç»˜åˆ¶å›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 1. åŸºç¡€æ ·å¼ (æ ·å¼ä¸ä½“æ£€æ¯”è¾ƒ.HTMLä¿æŒä¸€è‡´) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", "SimSun", sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f3f4f6;
        }

        /* è§†å›¾åˆ‡æ¢çš„CSS (æ ¸å¿ƒé€»è¾‘) */
        .non-key-item, .non-key-block { display: none; }
        body.show-full-data .subsection-title.non-key-item { display: block; }
        body.show-full-data .comparison-grid.non-key-item { display: grid; }
        body.show-full-data table.lab-table.non-key-item { display: table; }
        body.show-full-data tr.non-key-item { display: table-row; }
        body.show-full-data .comparison-item.non-key-block { display: block; }
        
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .logo { font-size: 36px; font-weight: bold; margin-bottom: 5px; }
        .title-main { font-size: 28px; font-weight: bold; margin: 10px 0; }
        .section-title {
            background: #1e3a8a;
            color: white;
            padding: 15px 20px;
            font-size: 20px;
            font-weight: bold;
            margin: 30px 0 20px 0;
            text-align: center;
            border-radius: 5px;
        }
        .subsection-title {
            background: #f3f4f6;
            padding: 10px 15px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            border-left: 4px solid #1e3a8a;
        }
        .content-box {
            background: #fff;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        
        .highlight { color: #dc2626; font-weight: bold; }
        .highlight-green { color: #16a34a; font-weight: bold; }
        
        /* 2. AI åˆ†ææ¨¡å—æ ·å¼ */
        .ai-judge-box {
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 15px;
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        .judge-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #b45309;
            font-size: 18px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chart-container h4 {
            text-align: center;
            font-size: 16px;
            margin-bottom: 15px;
            color: #1e3a8a;
        }
        .status-box {
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 5px;
            border-left-width: 4px;
            border-left-style: solid;
        }
        .status-green { background: #e8f5e9; border-color: #4caf50; }
        .status-yellow { background: #fffbeb; border-color: #f59e0b; }
        .status-box ul { list-style-position: inside; padding-left: 5px; }
        .status-box li { margin-bottom: 8px; }
        
        /* è§†å›¾åˆ‡æ¢å¼€å…³æ ·å¼ */
        .view-switcher {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fff;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .view-switcher-label { font-size: 16px; font-weight: bold; color: #1e3a8a; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* 3. è¯¦ç»†æ•°æ®è¡¨æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 5px;
            overflow: hidden;
            min-width: 800px;
        }
        table th {
            background: #1e3a8a;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 14px;
        }
        table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        table tr:last-child td { border-bottom: none; }
        table tr:nth-child(even) { background: #f9fafb; }
        
        .vitals-table th:nth-child(1), .vitals-table td:nth-child(1) { font-weight: bold; }
        .vitals-table td:not(:first-child) { text-align: center; }
        .vitals-table th:not(:first-child) { text-align: center; }

        .lab-table th:nth-child(1), .lab-table td:nth-child(1) { font-weight: bold; min-width: 150px; }
        .lab-table th:nth-child(2), .lab-table td:nth-child(2) { min-width: 80px; color: #666; }
        .lab-table th:nth-child(3), .lab-table td:nth-child(3) { min-width: 100px; color: #666; }
        
        .comparison-grid {
            display: grid;
            /* åˆ—æ•°å°†ç”±JSæ ¹æ®å¹´ä»½æ•°é‡åŠ¨æ€è®¾ç½® */
            gap: 15px;
        }
        .comparison-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
        }
        .comparison-item h4 {
            font-size: 16px;
            color: #1e3a8a;
            margin-bottom: 5px;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 5px;
        }
        .comparison-item p { font-size: 13px; line-height: 1.5; }
        .comparison-item ul { padding-left: 20px; font-size: 13px; }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .comparison-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 900px) {
            .chart-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .comparison-grid { grid-template-columns: 1fr; }
            .view-switcher { flex-direction: column; align-items: flex-start; gap: 10px; }
            table { font-size: 12px; }
            table th { padding: 10px 5px; }
            table td { padding: 8px 5px; }
        }
    </style>
</head>
<body class=""> <!-- é»˜è®¤æ²¡æœ‰ 'show-full-data' ç±» -->

    <div class="container">
        
        <!-- 1. é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <div class="logo">INCOSC</div>
            <div class="title-main" id="title-main">
                å†å¹´ç»¼åˆåˆ†ææŠ¥å‘Š ({{headerInfo.yearRange}})
            </div>
            <div id="patient-info">
                ä¼šå‘˜: {{headerInfo.patientName}} ({{headerInfo.patientGender}}, {{headerInfo.latestAge}}å²)
            </div>
        </div>

        <!-- 2. å…³é”®ä½“å¾å˜åŒ– -->
        <div class="content-box">
            <div class="subsection-title">å…³é”®ä½“å¾å˜åŒ–</div>
            <!-- æ­¤è¡¨æ ¼å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            <div id="key-vitals-container">
                <!-- å ä½ç¬¦ç»“æ„ (å°†è¢«JSæ›¿æ¢) -->
                <table class="vitals-table">
                    <thead>
                        <tr>
                            <th>æŒ‡æ ‡</th>
                            <th>{{keyVitals.exams[0].examDate}} ({{keyVitals.exams[0].age}}å²)</th>
                            <th>{{keyVitals.exams[1].examDate}} ({{keyVitals.exams[1].age}}å²)</th>
                            <!-- æ›´å¤šå¹´ä»½... -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{keyVitals.metrics[0].name}}</td>
                            <td>{{keyVitals.metrics[0].values[0]}}</td>
                            <td>{{keyVitals.metrics[0].values[1]}}</td>
                            <!-- æ›´å¤šå€¼... -->
                        </tr>
                        <tr>
                            <td>{{keyVitals.metrics[1].name}}</td>
                            <td>{{keyVitals.metrics[1].values[0]}}</td>
                            <td>{{keyVitals.metrics[1].values[1]}}</td>
                            <!-- æ›´å¤šå€¼... -->
                        </tr>
                        <!-- æ›´å¤šæŒ‡æ ‡... -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- è§†å›¾åˆ‡æ¢å¼€å…³ -->
        <div class="view-switcher">
            <span class="view-switcher-label">ğŸ”„ è§†å›¾æ¨¡å¼: <span id="view-mode-text">ä»…æ˜¾ç¤ºå…³é”®é¡¹</span></span>
            <label class="switch">
                <input type="checkbox" id="view-toggle-switch">
                <span class="slider"></span>
            </label>
        </div>

        <!-- 3. AI ç»¼åˆè¯„ä»· -->
        <div class="ai-judge-box">
            <div class="judge-title" id="ai-summary-title">
                {{aiSummary.title}}
            </div>
            <p id="ai-summary-introduction">{{aiSummary.introduction}}</p>
            <ul id="ai-summary-points" style="list-style-position: inside; margin-top: 10px; padding-left: 5px;">
                <li>{{aiSummary.points[0]}}</li>
                <li>{{aiSummary.points[1]}}</li>
                <li>...</li>
            </ul>
            <p id="ai-summary-conclusion" style="margin-top: 10px;">{{aiSummary.conclusion}}</p>
        </div>

        <!-- 4. å…³é”®æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨ -->
        <div class="content-box">
            <div class="subsection-title">å…³é”®æŒ‡æ ‡è¶‹åŠ¿å›¾</div>
            <!-- å›¾è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            <div id="charts-container" class="chart-grid">
                <!-- 
                å ä½ç¬¦ç»“æ„ (JSå°†å¾ªç¯åˆ›å»º):
                <div class="chart-container">
                    <h4>{{chartData.charts[0].title}}</h4>
                    <canvas id="{{chartData.charts[0].id}}"></canvas>
                </div>
                -->
            </div>
        </div>

        <!-- 5. ä¿æŒä¸æ”¹å–„ / é£é™©ä¸å…³æ³¨ -->
        <div class="content-box">
            <div class="subsection-title">ä¿æŒä¸æ”¹å–„ (å€¼å¾—è‚¯å®š)</div>
            <div class="status-box status-green">
                <ul id="status-improvements">
                     <li>{{statusSummary.improvements[0]}}</li>
                     <li>...</li>
                </ul>
            </div>

            <div class="subsection-title">é£é™©ä¸å…³æ³¨ (éœ€è¦æ³¨æ„)</div>
            <div class="status-box status-yellow">
                <ul id="status-risks">
                    <li>{{statusSummary.risks[0]}}</li>
                    <li>...</li>
                </ul>
            </div>
        </div>


        <!-- 6. ä¸“ç§‘æ£€æŸ¥å¯¹æ¯” -->
        <div class="section-title">ä¸“ç§‘æ£€æŸ¥å¯¹æ¯” <span class="view-mode-title">(å…³é”®é¡¹)</span></div>
        <div class="content-box">
            <!-- å ä½ç¬¦: {{specialistExams[0].category}} {{specialistExams[0].finding}} -->
            <div id="specialist-exams-container">
                <!-- JS å¾ªç¯æ¸²æŸ“: specialistExams (from detailedData) -->
                <!-- ç¤ºä¾‹: {{specialistExams[0].category}} -->
                <!-- {{specialistExams[0].finding}}, {{specialistExams[0].assessment}} -->
            </div>
        </div>
        
        <!-- 7. å½±åƒæ£€æŸ¥å¯¹æ¯” -->
        <div class="section-title">å½±åƒæ£€æŸ¥å¯¹æ¯” <span class="view-mode-title">(å…³é”®é¡¹)</span></div>
        <div class="content-box">
            <!-- å ä½ç¬¦: {{imagingResults[0].category}} {{imagingResults[0].assessment}} -->
            <div id="imaging-results-container">
                <!-- JS å¾ªç¯æ¸²æŸ“: imagingResults (from detailedData) -->
                <!-- ç¤ºä¾‹: {{imagingResults[0].category}} -->
                <!-- {{imagingResults[0].assessment}}, {{imagingResults[0].findings}} -->
            </div>
        </div>

        <!-- 8. å®éªŒå®¤æ£€æŸ¥è¯¦ç»†å¯¹æ¯” -->
        <div class="section-title">å®éªŒå®¤æ£€æŸ¥è¯¦ç»†å¯¹æ¯” <span class="view-mode-title">(å…³é”®é¡¹)</span></div>
        <div class="content-box">
            <!-- å ä½ç¬¦: {{labResults[0].category}} {{labResults[0].items[0].name}} -->
            <div id="lab-results-container">
                <!-- JS å¾ªç¯æ¸²æŸ“: labResults (from detailedData) -->
                <!-- ç¤ºä¾‹: {{labResults[0].category}} -->
                <!-- {{labResults[0].items[0].name}}, {{labResults[0].items[0].value}} -->
            </div>
        </div>

    </div>

    <script>
        // --- 1. å®šä¹‰å…³é”®é¡¹ (ç”¨äºåˆ‡æ¢è§†å›¾) ---
        // æ‚¨å¯ä»¥åœ¨è¿™é‡Œè‡ªå®šä¹‰å“ªäº›é¡¹æ˜¯â€œå…³é”®é¡¹â€
        const keySpecialistExams = ['å¤–ç§‘', 'å¦‡ç§‘'];
        const keyImagingResults = ['è¶…å£°ï¼ˆå¿ƒè„ï¼Œè¡€ç®¡ï¼‰', 'è¶…å£°ï¼ˆç”²çŠ¶è…ºï¼Œè‚èƒ†èƒ°è„¾ï¼Œæ³Œå°¿ç³»ç»Ÿï¼‰', 'Xçº¿æˆ–CTï¼ˆé¢ˆï¼Œèƒ¸ï¼Œè…¹éƒ¨ï¼‰'];
        const keyLabItems = [
            'å°¿è›‹ç™½', 'è¡€å°¿é…¸', 'æ€»èƒ†å›ºé†‡', 'è„‚è›‹ç™½ a', 'èƒƒæ³Œç´ 17', 
            'HDL-èƒ†å›ºé†‡', 'ç”˜æ²¹ä¸‰é…¯', 'TCT(æ¶²åŸºè¶…è–„ç»†èƒæ£€æµ‹)', 
            'å•é¡¹è¡¥ä½“æµ‹å®š(C3)', 'å•é¡¹è¡¥ä½“æµ‹å®š(C4)', 'é…¸ç¢±åº¦ï¼ˆPHï¼‰'
        ];
        
        // --- 2. è¾…åŠ©å‡½æ•° ---
        
        /**
         * å®‰å…¨è½¬ä¹‰HTML
         */
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString().replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }
        
        /**
         * æ ¼å¼åŒ–å®éªŒå®¤æ£€æŸ¥å€¼ (å¤„ç†é«˜äº®)
         * (æ­¤å‡½æ•°ä¸ºç¤ºä¾‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“é«˜äº®é€»è¾‘è°ƒæ•´)
         */
        function formatValue(item, yearKey, allYearsData) {
            let valueStr = ''; 
            if (!item || !item.values || !item.values[yearKey] || item.values[yearKey].value === null) {
                return '<span style="color: #999;">-</span>';
            }
            const data = item.values[yearKey];
            valueStr = escapeHTML(data.value);
            
            if (data.isAbnormal) {
                // ç¤ºä¾‹ï¼šç®€å•çš„æ ‡çº¢
                return `<span class="highlight">${valueStr}</span>`;
            }
            return valueStr;
        }

        // --- 3. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---

        /**
         * å¡«å……é™æ€å†…å®¹ (AIæ‘˜è¦, çŠ¶æ€æ€»ç»“ç­‰)
         */
        function renderStaticContent(summaryData) {
            const { headerInfo, aiSummary, statusSummary } = summaryData;

            // æ ‡é¢˜
            document.title = `${headerInfo.patientName} - å†å¹´ç»¼åˆåˆ†ææŠ¥å‘Š (${headerInfo.yearRange})`;
            document.getElementById('title-main').textContent = `å†å¹´ç»¼åˆåˆ†ææŠ¥å‘Š (${headerInfo.yearRange})`;
            document.getElementById('patient-info').textContent = `ä¼šå‘˜: ${headerInfo.patientName} (${headerInfo.patientGender}, ${headerInfo.latestAge}å²)`;

            // AI æ‘˜è¦
            document.getElementById('ai-summary-title').textContent = aiSummary.title;
            document.getElementById('ai-summary-introduction').textContent = aiSummary.introduction;
            document.getElementById('ai-summary-conclusion').textContent = aiSummary.conclusion;
            
            const pointsUl = document.getElementById('ai-summary-points');
            pointsUl.innerHTML = ''; // æ¸…ç©º
            aiSummary.points.forEach(point => {
                pointsUl.innerHTML += `<li>${escapeHTML(point)}</li>`;
            });

            // çŠ¶æ€æ€»ç»“
            const improvementsUl = document.getElementById('status-improvements');
            improvementsUl.innerHTML = ''; // æ¸…ç©º
            statusSummary.improvements.forEach(item => {
                improvementsUl.innerHTML += `<li>${escapeHTML(item)}</li>`;
            });

            const risksUl = document.getElementById('status-risks');
            risksUl.innerHTML = ''; // æ¸…ç©º
            statusSummary.risks.forEach(item => {
                risksUl.innerHTML += `<li>${escapeHTML(item)}</li>`;
            });
        }

        /**
         * åŠ¨æ€æ¸²æŸ“å…³é”®ä½“å¾è¡¨ (Vitals)
         */
        function renderVitals(keyVitals) {
            const container = document.getElementById('key-vitals-container');
            if (!container) return;

            let html = '<table class="vitals-table"><thead><tr><th>æŒ‡æ ‡</th>';
            // åŠ¨æ€ç”Ÿæˆè¡¨å¤´ (å¹´ä»½)
            keyVitals.exams.forEach(exam => {
                html += `<th>${escapeHTML(exam.examDate)} (${escapeHTML(exam.age)}å²)</th>`;
            });
            html += '</tr></thead><tbody>';

            // åŠ¨æ€ç”Ÿæˆè¡¨ä½“ (æŒ‡æ ‡)
            keyVitals.metrics.forEach(metric => {
                html += `<tr><td>${escapeHTML(metric.name)}</td>`;
                metric.values.forEach(value => {
                    // TODO: åœ¨è¿™é‡Œæ·»åŠ é«˜äº®é€»è¾‘ (e.g., if (metric.name === 'ä½“é‡ (kg)' && value > 60))
                    html += `<td>${escapeHTML(value)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /**
         * æ¸²æŸ“å›¾è¡¨ (åŠ¨æ€ç‰ˆæœ¬)
         */
        function renderCharts(chartData) {
            const container = document.getElementById('charts-container');
            if (!container) return;

            // é”€æ¯å¯èƒ½å­˜åœ¨çš„æ—§å›¾è¡¨
            (chartData.charts || []).forEach(chartConfig => {
                 let chartStatus = Chart.getChart(chartConfig.id); 
                 if (chartStatus) chartStatus.destroy();
            });

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            const commonLabels = chartData.labels || [];

            // å¾ªç¯åˆ›å»ºå›¾è¡¨
            (chartData.charts || []).forEach(chartConfig => {
                // 1. åˆ›å»ºHTMLç»“æ„
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'chart-container';
                
                const title = document.createElement('h4');
                title.textContent = chartConfig.title;
                
                const canvas = document.createElement('canvas');
                canvas.id = chartConfig.id;
                
                chartWrapper.appendChild(title);
                chartWrapper.appendChild(canvas);
                container.appendChild(chartWrapper);

                // 2. å‡†å¤‡å›¾è¡¨é…ç½®
                const datasets = (chartConfig.datasets || []).map(ds => {
                    // åœ¨è¿™é‡Œå¯ä»¥è®¾ç½®ä¸€äº›é»˜è®¤å€¼
                    return {
                        label: ds.label,
                        data: ds.data,
                        borderColor: ds.borderColor, // e.g., '#3b82f6'
                        backgroundColor: ds.backgroundColor, // e.g., 'rgba(59, 130, 246, 0.1)'
                        fill: ds.fill !== undefined ? ds.fill : (ds.backgroundColor ? true : false),
                        tension: ds.tension !== undefined ? ds.tension : 0.1,
                        yAxisID: ds.yAxisID || 'y',
                        borderDash: ds.borderDash,
                        pointRadius: ds.pointRadius
                    };
                });

                // å¤„ç† scalesï¼Œç¡®ä¿ yAxisID åŒ¹é…
                const scales = {};
                if (chartConfig.scales) {
                    Object.keys(chartConfig.scales).forEach(axisId => {
                        const scaleConfig = chartConfig.scales[axisId];
                        scales[axisId] = {
                            type: scaleConfig.type || 'linear',
                            display: true,
                            position: scaleConfig.position || 'left',
                            title: {
                                display: !!scaleConfig.title,
                                text: scaleConfig.title || ''
                            },
                            grid: scaleConfig.grid || {}
                        };
                    });
                }
                
                // 3. å®ä¾‹åŒ–å›¾è¡¨
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: chartConfig.type || 'line',
                    data: {
                        labels: commonLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    // åŠ¨æ€è¿‡æ»¤æ‰å‚è€ƒçº¿
                                    filter: item => item.label && !item.label.includes('å‚è€ƒ')
                                }
                            }
                        },
                        scales: scales
                    }
                });
            });
        }
        
        /**
         * åŠ¨æ€æ¸²æŸ“ä¸“ç§‘æ£€æŸ¥
         */
        function renderSpecialistExams(reports) {
            const container = document.getElementById('specialist-exams-container');
            if (!container) return; 
            const categoryMap = new Map();
            const years = reports.map(r => r.patientInfo.examDate.substring(0, 4)); // åŠ¨æ€è·å–å¹´ä»½

            reports.forEach(report => {
                const year = report.patientInfo.examDate.substring(0, 4);
                (report.specialistExams || []).forEach(exam => {
                    if (!categoryMap.has(exam.category)) {
                        categoryMap.set(exam.category, {});
                    }
                    categoryMap.get(exam.category)[year] = {
                        finding: exam.finding,
                        assessment: exam.assessment
                    };
                });
            });

            let html = '';
            categoryMap.forEach((yearData, category) => {
                const isKey = keySpecialistExams.includes(category);
                const categoryClass = isKey ? 'key-item' : 'non-key-item';
                const blockClass = isKey ? 'key-block' : 'non-key-block'; 

                html += `<div class="subsection-title ${categoryClass}">${escapeHTML(category)}</div>`;
                // åŠ¨æ€è®¾ç½®ç½‘æ ¼åˆ—æ•°
                html += `<div class="comparison-grid ${categoryClass}" style="grid-template-columns: repeat(${years.length}, 1fr);">`;
                
                years.forEach(year => {
                    const data = yearData[year];
                    html += `<div class="comparison-item ${blockClass}"><h4>${year}</h4>`;
                    if (data) {
                        html += `<p><strong>æ£€æŸ¥æ‰€è§:</strong> ${escapeHTML(data.finding)}</p>`;
                        if(data.assessment) {
                             html += `<p style="margin-top:10px; border-top: 1px dashed #ccc; padding-top: 5px;"><strong>è¯„ä¼°:</strong> ${escapeHTML(data.assessment)}</p>`;
                        }
                    } else {
                        html += `<p style="color: #999;">æœªæ£€æŸ¥</p>`;
                    }
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        /**
         * åŠ¨æ€æ¸²æŸ“å½±åƒæ£€æŸ¥
         */
        function renderImagingResults(reports) {
            const container = document.getElementById('imaging-results-container');
            if (!container) return;
            const categoryMap = new Map();
            const years = reports.map(r => r.patientInfo.examDate.substring(0, 4));

            reports.forEach(report => {
                const year = report.patientInfo.examDate.substring(0, 4);
                (report.imagingResults || []).forEach(exam => {
                    if (!categoryMap.has(exam.category)) {
                        categoryMap.set(exam.category, {});
                    }
                    categoryMap.get(exam.category)[year] = {
                        assessment: exam.assessment,
                        findings: exam.findings
                    };
                });
            });

            let html = '';
            categoryMap.forEach((yearData, category) => {
                const isKey = keyImagingResults.includes(category);
                const categoryClass = isKey ? 'key-item' : 'non-key-item';
                const blockClass = isKey ? 'key-block' : 'non-key-block';

                html += `<div class="subsection-title ${categoryClass}">${escapeHTML(category)}</div>`;
                html += `<div class="comparison-grid ${categoryClass}" style="grid-template-columns: repeat(${years.length}, 1fr);">`;
                
                years.forEach(year => {
                    const data = yearData[year];
                    html += `<div class="comparison-item ${blockClass}"><h4>${year}</h4>`;
                    if (data) {
                        html += `<p><strong>è¯„ä¼°ç»“è®º:</strong> ${escapeHTML(data.assessment)}</p>`;
                        if(data.findings && data.findings.length > 0) {
                             html += `<p style="margin-top:10px;"><strong>ä¸»è¦æ‰€è§:</strong></p><ul>`;
                             data.findings.forEach(f => {
                                 html += `<li>${escapeHTML(f)}</li>`;
                             });
                             html += `</ul>`;
                        }
                    } else {
                        html += `<p style="color: #999;">æœªæ£€æŸ¥</p>`;
                    }
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        /**
         * åŠ¨æ€æ¸²æŸ“å®éªŒå®¤æ£€æŸ¥
         */
        function renderLabResults(reports) {
            const container = document.getElementById('lab-results-container');
            if (!container) return;
            const categoryMap = new Map(); 
            const years = reports.map(r => r.patientInfo.examDate.substring(0, 4));

            reports.forEach(report => {
                const year = report.patientInfo.examDate.substring(0, 4);
                (report.labResults || []).forEach(category => {
                    if (!categoryMap.has(category.category)) {
                        categoryMap.set(category.category, { items: new Map() });
                    }
                    const categoryData = categoryMap.get(category.category);

                    (category.items || []).forEach(item => {
                        const itemName = item.name;
                        if (!categoryData.items.has(itemName)) {
                            categoryData.items.set(itemName, {
                                name: itemName,
                                ref: item.referenceRange || '',
                                unit: item.unit || '',
                                values: {}
                            });
                        }
                        const itemData = categoryData.items.get(itemName);
                        itemData.values[year] = {
                            value: item.value,
                            isAbnormal: item.isAbnormal
                        };
                        // è¡¥å……å‚è€ƒèŒƒå›´å’Œå•ä½
                        if ((!itemData.ref && item.referenceRange) || item.referenceRange === 'é˜´æ€§') {
                            itemData.ref = item.referenceRange;
                        }
                         if (!itemData.unit && item.unit) {
                            itemData.unit = item.unit;
                        }
                    });
                });
            });

            let html = '';
            categoryMap.forEach((categoryData, categoryName) => {
                let categoryHasKeyItem = false;
                categoryData.items.forEach(item => {
                    if (keyLabItems.includes(item.name)) {
                        categoryHasKeyItem = true;
                    }
                });
                
                const categoryClass = categoryHasKeyItem ? 'key-category' : 'non-key-item';

                html += `<div class="subsection-title ${categoryClass}">${escapeHTML(categoryName)}</div>`;
                html += `<table class="lab-table ${categoryClass}">`;
                html += `<thead>
                            <tr>
                                <th>é¡¹ç›®åç§°</th>
                                <th>å•ä½</th>
                                <th>å‚è€ƒèŒƒå›´</th>`;
                // åŠ¨æ€å¹´ä»½è¡¨å¤´
                years.forEach(year => {
                    html += `<th>${year}</th>`;
                });
                html += `</tr></thead><tbody>`;

                categoryData.items.forEach(item => {
                    const rowClass = keyLabItems.includes(item.name) ? 'key-item' : 'non-key-item';
                    
                    html += `<tr class="${rowClass}">
                                <td>${escapeHTML(item.name)}</td>
                                <td>${escapeHTML(item.unit)}</td>
                                <td>${escapeHTML(item.ref)}</td>`;
                    // åŠ¨æ€å¹´ä»½æ•°æ®
                    years.forEach(year => {
                         html += `<td>${formatValue(item, year, item.values)}</td>`;
                    });
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
            });

            container.innerHTML = html;
        }
        
        /**
         * è§†å›¾åˆ‡æ¢ (V5 é€»è¾‘)
         */
        function setupViewSwitcher() {
            const toggle = document.getElementById('view-toggle-switch');
            const modeText = document.getElementById('view-mode-text');
            const titles = document.querySelectorAll('.view-mode-title');
            
            if (toggle) {
                toggle.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('show-full-data');
                        modeText.textContent = 'æ˜¾ç¤ºå…¨éƒ¨æ•°æ®';
                        titles.forEach(t => t.textContent = '(å…¨éƒ¨æ•°æ®)');
                    } else {
                        document.body.classList.remove('show-full-data');
                        modeText.textContent = 'ä»…æ˜¾ç¤ºå…³é”®é¡¹';
                        titles.forEach(t => t.textContent = '(å…³é”®é¡¹)');
                    }
                });
            }
        }

        /**
         * 4. é¡µé¢åŠ è½½æ€»å…¥å£
         * @param {object} summaryData - å¯¹åº” "ä½“æ£€æ¯”è¾ƒä¾‹å­.JSON" çš„æ•°æ®
         * @param {Array<object>} detailedData - å¯¹åº” [2022.json, 2023.json, ...] çš„åŸå§‹æ•°æ®æ•°ç»„
         */
        function initializeReport(summaryData, detailedData) {
            // æ¸²æŸ“ V2 æ¨¡å— (æ‘˜è¦, æ€»ç»“, å›¾è¡¨, å…³é”®ä½“å¾)
            renderStaticContent(summaryData);
            renderVitals(summaryData.keyVitals);
            renderCharts(summaryData.chartData);
            
            // æ¸²æŸ“ V3 æ¨¡å— (è¯¦ç»†å¯¹æ¯”è¡¨)
            // **æ³¨æ„ï¼šè¿™é‡Œçš„å¹´ä»½é¡ºåºä¾èµ– detailedData æ•°ç»„çš„é¡ºåº**
            renderSpecialistExams(detailedData);
            renderImagingResults(detailedData);
            renderLabResults(detailedData);
            
            // å¯åŠ¨ V5 æ¨¡å— (è§†å›¾åˆ‡æ¢)
            setupViewSwitcher();
        }

        // --- 5. æ•°æ®åŠ è½½ç¤ºä¾‹ ---
        document.addEventListener('DOMContentLoaded', () => {
            // **
            // ** æ¨¡æ¿ä½¿ç”¨è€…ï¼šè¯·åœ¨æ­¤å¤„åŠ è½½æ‚¨çš„JSONæ•°æ® **
            // **
            
            // ç¤ºä¾‹ï¼šä½¿ç”¨ "ä½“æ£€æ¯”è¾ƒä¾‹å­.JSON" å’Œ åŸå§‹JSON (2022-2025)
            // åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ‚¨åº”è¯¥é€šè¿‡ fetch æˆ–å…¶ä»–æ–¹å¼åŠ è½½è¿™äº›æ•°æ®
            
            /*
            const exampleSummaryData = {
              ... (æµ‹è¯•æ•°æ®å·²ç§»é™¤) ...
            };
            */
            
            /*
            const exampleDetailedData = [
                ... (æµ‹è¯•æ•°æ®å·²ç§»é™¤) ...
            ];
            */

            // æ³¨æ„ï¼šä¸‹é¢çš„è°ƒç”¨æ˜¯ä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼Œå› æ­¤è¯¦ç»†è¡¨æ ¼å°†æ˜¾ç¤ºä¸ºç©º
            // æ‚¨éœ€è¦ç”¨çœŸå®çš„JSONæ•°æ®æ›¿æ¢ exampleDetailedData
            // ** é”™è¯¯ä¿®å¤ï¼šå°† 'DOMContentLoaded' æ›´æ”¹ä¸º 'window.onload' **
            // ç¡®ä¿åœ¨æ‰§è¡Œè„šæœ¬ä¹‹å‰ï¼ŒåŒ…æ‹¬ Chart.js åœ¨å†…çš„æ‰€æœ‰å¤–éƒ¨èµ„æºéƒ½å·²åŠ è½½
            window.onload = () => {
                // ** å·²æ³¨é‡Šæ‰ï¼Œä»¥ä¾¿æ˜¾ç¤ºHTMLä¸­çš„å ä½ç¬¦ **
                // const summaryData = ...; // æ‚¨éœ€è¦ä»å¤–éƒ¨åŠ è½½
                // const detailedData = ...; // æ‚¨éœ€è¦ä»å¤–éƒ¨åŠ è½½
                // initializeReport(summaryData, detailedData);
            };
            
            // å¦‚æœæ‚¨æƒ³åœ¨æ¨¡æ¿ä¸­ç¡¬ç¼–ç  detailedData (å°±åƒåŸå§‹ HTML é‚£æ ·)ï¼Œ
            // è¯·å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„è¡Œï¼Œå¹¶å°†æ‚¨çš„æ•°æ®ç²˜è´´åˆ°
            // const detailedDataFromHTML = [ { ...2022... }, { ...2023... }, ... ];
            // window.onload = () => {
            //    initializeReport(exampleSummaryData, detailedDataFromHTML);
            // };
        });
    </script>

</body>
</html>



