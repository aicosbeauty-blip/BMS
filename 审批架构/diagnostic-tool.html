<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè¯Šæ–­æ£€æŸ¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #f97316;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9fafb;
            border-left: 4px solid #f97316;
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .warning {
            color: #f59e0b;
            font-weight: bold;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #f97316;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #ea580c;
        }
        .info-box {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®¡æ‰¹æµç¨‹ç®¡ç†ç³»ç»Ÿ - è¯Šæ–­æ£€æŸ¥</h1>
        
        <div class="info-box">
            <strong>ğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            1. ç¡®ä¿ä½ çš„ä¸»é¡µé¢ï¼ˆindex.htmlï¼‰å·²ç»æ‰“å¼€å¹¶åŠ è½½å®Œæˆ<br>
            2. ç‚¹å‡»ä¸‹é¢çš„"å¼€å§‹è¯Šæ–­"æŒ‰é’®<br>
            3. æŸ¥çœ‹è¯Šæ–­ç»“æœï¼Œæ ¹æ®æç¤ºä¿®å¤é—®é¢˜
        </div>

        <button onclick="runDiagnostics()">ğŸ” å¼€å§‹è¯Šæ–­</button>
        <button onclick="checkVersion()">ğŸ“‹ æ£€æŸ¥ç‰ˆæœ¬</button>
        <button onclick="testRoleMatching()">ğŸ¯ æµ‹è¯•è§’è‰²åŒ¹é…</button>
        <button onclick="showRawData()">ğŸ“Š æŸ¥çœ‹åŸå§‹æ•°æ®</button>
        
        <div id="results"></div>
    </div>

    <script>
        function runDiagnostics() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="section"><h2>ğŸ” è¯Šæ–­ç»“æœ</h2>';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åœ¨ä¸»é¡µé¢çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ
            if (typeof availableRoles === 'undefined') {
                html += '<p class="error">âŒ æ— æ³•è®¿é—®ä¸»é¡µé¢æ•°æ®</p>';
                html += '<p>è¯·ç¡®ä¿ï¼š</p>';
                html += '<ol>';
                html += '<li>ä¸»é¡µé¢ï¼ˆindex.htmlï¼‰å·²ç»æ‰“å¼€</li>';
                html += '<li>åœ¨ä¸»é¡µé¢çš„æ§åˆ¶å°ï¼ˆF12ï¼‰ä¸­è¿è¡Œè¯Šæ–­è„šæœ¬</li>';
                html += '</ol>';
                html += '<p>æˆ–è€…å¤åˆ¶ä¸‹é¢çš„ä»£ç åˆ°ä¸»é¡µé¢æ§åˆ¶å°è¿è¡Œï¼š</p>';
                html += '<pre>' + getDiagnosticCode() + '</pre>';
                html += '</div>';
                resultsDiv.innerHTML = html;
                return;
            }

            // 1. æ£€æŸ¥è§’è‰²æ•°æ®
            html += '<h3>1. è§’è‰²æ•°æ®æ£€æŸ¥</h3>';
            if (typeof availableRoles !== 'undefined') {
                html += `<p class="success">âœ“ è§’è‰²æ•°æ®å·²åŠ è½½: ${availableRoles.length} ä¸ªè§’è‰²</p>`;
                if (availableRoles.length > 0) {
                    html += '<p>è§’è‰²åˆ—è¡¨ï¼š</p><ul>';
                    availableRoles.forEach(role => {
                        html += `<li>${role.name} (ID: ${role.id}, ${role.employeeCount} åå‘˜å·¥)</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p class="error">âŒ è§’è‰²åˆ—è¡¨ä¸ºç©ºï¼</p>';
                }
            } else {
                html += '<p class="error">âŒ è§’è‰²æ•°æ®æœªåŠ è½½</p>';
            }

            // 2. æ£€æŸ¥æµç¨‹æ•°æ®
            html += '<h3>2. æµç¨‹æ•°æ®æ£€æŸ¥</h3>';
            if (typeof processList !== 'undefined') {
                html += `<p class="success">âœ“ æµç¨‹æ•°æ®å·²åŠ è½½: ${processList.length} ä¸ªæµç¨‹</p>`;
                if (processList.length > 0) {
                    processList.forEach(process => {
                        html += `<p><strong>${process.name}</strong> (${process.nodes ? process.nodes.length : 0} ä¸ªèŠ‚ç‚¹)</p>`;
                    });
                }
            } else {
                html += '<p class="error">âŒ æµç¨‹æ•°æ®æœªåŠ è½½</p>';
            }

            // 3. æ£€æŸ¥å½“å‰å·¥ä½œæµ
            html += '<h3>3. å½“å‰å·¥ä½œæµæ£€æŸ¥</h3>';
            if (typeof workflowNodes !== 'undefined') {
                html += `<p>å½“å‰èŠ‚ç‚¹æ•°: ${workflowNodes.length}</p>`;
                if (workflowNodes.length > 0) {
                    html += '<table style="width:100%; border-collapse: collapse;">';
                    html += '<tr style="background:#f3f4f6;"><th style="padding:8px; border:1px solid #ddd;">èŠ‚ç‚¹</th><th style="padding:8px; border:1px solid #ddd;">è§’è‰²</th><th style="padding:8px; border:1px solid #ddd;">å‘˜å·¥æ•°</th><th style="padding:8px; border:1px solid #ddd;">çŠ¶æ€</th></tr>';
                    workflowNodes.forEach((node, i) => {
                        const empCount = node.employees ? node.employees.length : 0;
                        const status = empCount > 0 ? '<span class="success">âœ“</span>' : '<span class="error">âœ—</span>';
                        html += `<tr>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">èŠ‚ç‚¹ ${i+1}</td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${node.role || node.roleName || 'æœªçŸ¥'}</td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${empCount}</td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${status}</td>`;
                        html += `</tr>`;
                        if (empCount > 0) {
                            html += `<tr><td colspan="4" style="padding:8px; border:1px solid #ddd; font-size:12px; color:#666;">å‘˜å·¥: ${node.employees.map(e => e.name).join(', ')}</td></tr>`;
                        }
                    });
                    html += '</table>';
                } else {
                    html += '<p class="warning">âš  å½“å‰æ²¡æœ‰å·¥ä½œæµèŠ‚ç‚¹</p>';
                }
            }

            // 4. è§’è‰²åŒ¹é…æµ‹è¯•
            html += '<h3>4. è§’è‰²åŒ¹é…æµ‹è¯•</h3>';
            if (typeof workflowNodes !== 'undefined' && typeof availableRoles !== 'undefined' && workflowNodes.length > 0) {
                html += '<table style="width:100%; border-collapse: collapse;">';
                html += '<tr style="background:#f3f4f6;"><th style="padding:8px; border:1px solid #ddd;">èŠ‚ç‚¹è§’è‰²</th><th style="padding:8px; border:1px solid #ddd;">åŒ¹é…çŠ¶æ€</th><th style="padding:8px; border:1px solid #ddd;">è¯¦æƒ…</th></tr>';
                workflowNodes.forEach(node => {
                    const roleName = node.role || node.roleName;
                    const matchedRole = availableRoles.find(r => r.name === roleName);
                    if (matchedRole) {
                        html += `<tr>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${roleName}</td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;"><span class="success">âœ“ æ‰¾åˆ°åŒ¹é…</span></td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${matchedRole.employeeCount} åå‘˜å·¥</td>`;
                        html += `</tr>`;
                    } else {
                        html += `<tr>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">${roleName}</td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;"><span class="error">âœ— æœªæ‰¾åˆ°</span></td>`;
                        html += `<td style="padding:8px; border:1px solid #ddd;">æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å®Œå…¨åŒ¹é…</td>`;
                        html += `</tr>`;
                    }
                });
                html += '</table>';
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function checkVersion() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="section"><h2>ğŸ“‹ ç‰ˆæœ¬æ£€æŸ¥</h2>';
            
            // æ£€æŸ¥selectProcesså‡½æ•°çš„ä»£ç 
            if (typeof selectProcess === 'function') {
                const funcStr = selectProcess.toString();
                if (funcStr.includes('å¤„ç†èŠ‚ç‚¹') && funcStr.includes('å‘˜å·¥åˆ—è¡¨:')) {
                    html += '<p class="success">âœ“ ç‰ˆæœ¬æ­£ç¡®ï¼šå·²ä½¿ç”¨ v1.2 ç‰ˆæœ¬</p>';
                    html += '<p>åŒ…å«è¯¦ç»†æ—¥å¿—è¾“å‡ºåŠŸèƒ½</p>';
                } else if (funcStr.includes('æ–¹å¼2ï¼šé€šè¿‡roleåç§°æŸ¥æ‰¾')) {
                    html += '<p class="warning">âš  ç‰ˆæœ¬ï¼šv1.1ï¼ˆéƒ¨åˆ†ä¿®å¤ï¼‰</p>';
                    html += '<p class="error">å»ºè®®æ›´æ–°åˆ° v1.2 è·å–è¯¦ç»†æ—¥å¿—</p>';
                } else {
                    html += '<p class="error">âœ— ç‰ˆæœ¬è¿‡æ—§ï¼šv1.0 æˆ–æ›´æ—©</p>';
                    html += '<p class="error">è¯·ç«‹å³æ›´æ–° main-logic.js æ–‡ä»¶ï¼</p>';
                }
            } else {
                html += '<p class="error">âœ— æ— æ³•æ£€æµ‹ç‰ˆæœ¬ï¼ˆå‡½æ•°ä¸å­˜åœ¨ï¼‰</p>';
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function testRoleMatching() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="section"><h2>ğŸ¯ è§’è‰²åŒ¹é…è¯¦ç»†æµ‹è¯•</h2>';
            
            if (typeof workflowNodes === 'undefined' || typeof availableRoles === 'undefined') {
                html += '<p class="error">âŒ æ•°æ®æœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•</p></div>';
                resultsDiv.innerHTML = html;
                return;
            }

            html += '<h3>å¯ç”¨è§’è‰²å®Œæ•´åˆ—è¡¨</h3>';
            html += '<ul>';
            availableRoles.forEach(role => {
                html += `<li><strong>${role.name}</strong> (ID: ${role.id})`;
                if (role.employees && role.employees.length > 0) {
                    html += `<br>&nbsp;&nbsp;å‘˜å·¥ (${role.employees.length}): `;
                    html += role.employees.slice(0, 5).map(e => e.RUSERNAME).join(', ');
                    if (role.employees.length > 5) html += ` ...ç­‰${role.employees.length}äºº`;
                } else {
                    html += `<br>&nbsp;&nbsp;<span class="error">æ— å‘˜å·¥æ•°æ®</span>`;
                }
                html += '</li>';
            });
            html += '</ul>';

            html += '<h3>èŠ‚ç‚¹è§’è‰²åŒ¹é…ç»“æœ</h3>';
            workflowNodes.forEach((node, i) => {
                const roleName = node.role || node.roleName;
                html += `<p><strong>èŠ‚ç‚¹ ${i+1}: ${roleName}</strong></p>`;
                html += '<ul>';
                
                // å°è¯•å„ç§åŒ¹é…æ–¹å¼
                const exactMatch = availableRoles.find(r => r.name === roleName);
                const caseInsensitiveMatch = availableRoles.find(r => r.name.toLowerCase() === roleName.toLowerCase());
                const containsMatch = availableRoles.filter(r => r.name.includes(roleName) || roleName.includes(r.name));
                
                if (exactMatch) {
                    html += `<li class="success">âœ“ ç²¾ç¡®åŒ¹é…: ${exactMatch.name}</li>`;
                } else {
                    html += `<li class="error">âœ— æ— ç²¾ç¡®åŒ¹é…</li>`;
                }
                
                if (caseInsensitiveMatch && !exactMatch) {
                    html += `<li class="warning">âš  å¤§å°å†™ä¸åŒ¹é…: "${roleName}" vs "${caseInsensitiveMatch.name}"</li>`;
                }
                
                if (containsMatch.length > 0 && !exactMatch) {
                    html += `<li class="warning">âš  å¯èƒ½çš„ç›¸ä¼¼è§’è‰²: ${containsMatch.map(r => r.name).join(', ')}</li>`;
                }
                
                html += '</ul>';
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function showRawData() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="section"><h2>ğŸ“Š åŸå§‹æ•°æ®</h2>';
            
            html += '<h3>è§’è‰²æ•°æ® (availableRoles)</h3>';
            html += '<pre>' + JSON.stringify(availableRoles || [], null, 2) + '</pre>';
            
            html += '<h3>å·¥ä½œæµèŠ‚ç‚¹ (workflowNodes)</h3>';
            html += '<pre>' + JSON.stringify(workflowNodes || [], null, 2) + '</pre>';
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function getDiagnosticCode() {
            return `// åœ¨ä¸»é¡µé¢æ§åˆ¶å°è¿è¡Œæ­¤ä»£ç 
console.log('=== ç³»ç»Ÿè¯Šæ–­ ===');
console.log('è§’è‰²æ•°:', availableRoles?.length || 0);
console.log('æµç¨‹æ•°:', processList?.length || 0);
console.log('èŠ‚ç‚¹æ•°:', workflowNodes?.length || 0);
if (workflowNodes) {
    workflowNodes.forEach((n, i) => {
        console.log(\`èŠ‚ç‚¹\${i+1}: \${n.role}, å‘˜å·¥æ•°: \${n.employees?.length || 0}\`);
    });
}`;
        }
    </script>
</body>
</html>
